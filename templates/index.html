<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>CSV Data D3.js Visualization</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; }
        .chart { margin: 40px; }
        .bar { fill: steelblue; }
        .bar:hover { fill: orange; }
        .axis-label { font-size: 12px; }
        .anchor { cursor: move; }
    </style>
</head>
<body>
    <h1>Visualizaci√≥n de Datos con D3.js</h1>
    <div id="radviz"></div>
    <script>
        // Data and config from Flask
        const data = {{ data|safe }};
        const dimensions = {{ dimensions|safe }};
        const label_col = "{{ label_col }}";

        const width = 700, height = 400, margin = 40;
        const radius = Math.min(width, height) / 2 - margin;
        const D = dimensions.length;
        const anchors = dimensions.map((dim, j) => ({
          dim,
          x: radius * Math.cos((j * 2 * Math.PI) / D),
          y: radius * Math.sin((j * 2 * Math.PI) / D)
        }));

        // Function to compute RadViz positions
        function computePositions() {
          return data.map(d => {
            const values = dimensions.map(dim => +d[dim]);
            const sum = values.reduce((a, b) => a + b, 0) || 1;
            let x = 0, y = 0;
            dimensions.forEach((dim, j) => {
              const weight = values[j] / sum;
              x += weight * anchors[j].x;
              y += weight * anchors[j].y;
            });
            return {x, y, label: d[label_col]};
          });
        }

        // Initial point positions
        let points = computePositions();

        // Color scale
        const classes = Array.from(new Set(points.map(d => d.label)));
        const color = d3.scaleOrdinal()
          .domain(classes)
          .range(d3.schemeCategory10);

        // Tooltip div
        const tooltip = d3.select("body").append("div")
          .style("position", "absolute")
          .style("pointer-events", "none")
          .style("background", "rgba(255,255,255,0.95)")
          .style("border", "1px solid #ccc")
          .style("padding", "4px 8px")
          .style("border-radius", "4px")
          .style("font", "12px sans-serif")
          .style("display", "none");

        // Draw SVG
        const svg = d3.select("#radviz")
          .append("svg")
          .attr("width", width)
          .attr("height", height);

        const g = svg.append("g")
          .attr("transform", `translate(${width/2},${height/2})`);

        // Panel circle
        g.append("circle")
          .attr("r", radius)
          .attr("fill", "#f8f8f8")
          .attr("stroke", "#ccc");

        // Drag behavior
        const drag = d3.drag()
          .on("start", dragStarted)
          .on("drag", dragged)
          .on("end", dragEnded);

        function dragStarted(event, d) {
          d3.select(this).raise().attr("fill", "orange");
        }

        function dragged(event, d) {
          // Calculate distance from center to keep within circle
          const dist = Math.sqrt(event.x * event.x + event.y * event.y);
          if (dist > radius) {
            const scale = radius / dist;
            d.x = event.x * scale;
            d.y = event.y * scale;
          } else {
            d.x = event.x;
            d.y = event.y;
          }
          
          // Update anchor position
          d3.select(this)
            .attr("cx", d.x)
            .attr("cy", d.y);
          
          // Update label position
          d3.select(`text[data-dim="${d.dim}"]`)
            .attr("x", d.x)
            .attr("y", d.y - 10);
          
          // Recalculate and update all points
          points = computePositions();
          updatePoints();
        }

        function dragEnded(event, d) {
          d3.select(this).attr("fill", "#555");
        }

        // Anchors
        g.selectAll(".anchor")
          .data(anchors)
          .enter()
          .append("circle")
          .attr("class", "anchor")
          .attr("r", 6)
          .attr("cx", d => d.x)
          .attr("cy", d => d.y)
          .attr("fill", "#555")
          .call(drag);

        g.selectAll(".anchor-label")
          .data(anchors)
          .enter()
          .append("text")
          .attr("class", "anchor-label")
          .attr("x", d => d.x)
          .attr("y", d => d.y - 10)
          .attr("text-anchor", "middle")
          .attr("data-dim", d => d.dim)
          .text(d => d.dim);

        // Dots container group
        const dotsGroup = g.append("g").attr("class", "dots-group");

        // Function to update points
        function updatePoints() {
          // Remove existing dots
          dotsGroup.selectAll(".dot").remove();
          
          // Add updated dots
          dotsGroup.selectAll(".dot")
            .data(points)
            .enter()
            .append("circle")
            .attr("class", "dot")
            .attr("r", 5)
            .attr("cx", d => d.x)
            .attr("cy", d => d.y)
            .attr("fill", d => color(d.label))
            .attr("opacity", 0.6)
            .on("mouseover", (event, d) => {
              tooltip
                .style("display", "block")
                .html(`<strong>Class:</strong> ${d.label}`);
            })
            .on("mousemove", event => {
              tooltip
                .style("left", (event.pageX + 10) + "px")
                .style("top", (event.pageY - 10) + "px");
            })
            .on("mouseout", () => {
              tooltip.style("display", "none");
            });
        }

        // Initial rendering of points
        updatePoints();
    </script>
</body>
</html> 